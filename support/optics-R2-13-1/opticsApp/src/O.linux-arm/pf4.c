/* C code for program pf4, generated by snc from ../pf4.st */
#include <string.h>
#include <stddef.h>
#include <stdio.h>
#include <limits.h>

#include "seq_snc.h"
# line 24 "../pf4.st"
#include <stdio.h>
# line 25 "../pf4.st"
#include <math.h>
# line 26 "../pf4.st"
#include <string.h>
# line 29 "../pf4.st"
#include "chantler.h"
# line 40 "../pf4.st"
static const EF_ID b1_mon = 1;
# line 41 "../pf4.st"
static const EF_ID b2_mon = 2;
# line 42 "../pf4.st"
static const EF_ID b3_mon = 3;
# line 43 "../pf4.st"
static const EF_ID b4_mon = 4;
# line 44 "../pf4.st"
static const EF_ID monoenergy_mon = 5;
# line 56 "../pf4.st"
static const EF_ID selectenergy_mon = 6;
# line 57 "../pf4.st"
static const EF_ID localenergy_mon = 7;
# line 70 "../pf4.st"
static const EF_ID debug_flag_mon = 8;
# line 75 "../pf4.st"
static const EF_ID bankctl_mon = 9;
# line 77 "../pf4.st"
static const EF_ID filpos_mon = 10;
# line 96 "../pf4.st"
static const EF_ID f1_mon = 11;
# line 97 "../pf4.st"
static const EF_ID f2_mon = 12;
# line 98 "../pf4.st"
static const EF_ID f3_mon = 13;
# line 99 "../pf4.st"
static const EF_ID f4_mon = 14;
# line 102 "../pf4.st"
static const EF_ID z1_mon = 15;
# line 103 "../pf4.st"
static const EF_ID z2_mon = 16;
# line 104 "../pf4.st"
static const EF_ID z3_mon = 17;
# line 105 "../pf4.st"
static const EF_ID z4_mon = 18;
# line 107 "../pf4.st"
static const EF_ID other1_mon = 19;
# line 108 "../pf4.st"
static const EF_ID other2_mon = 20;
# line 109 "../pf4.st"
static const EF_ID other3_mon = 21;
# line 110 "../pf4.st"
static const EF_ID other4_mon = 22;
# line 111 "../pf4.st"
static const EF_ID otherShow_mon = 23;
# line 129 "../pf4.st"

static double TiAbsorptionLength(double);
static double GlassAbsorptionLength(double);
static double AlAbsorptionLength(double);
static int isLegalOther(char *s);
static double OtherAbsorptionLength(double keV, char *species);
static int fillShowArrays(char *species, int N, float *E, float *T);

static int numInArray(int,short*,short);
static void sortDecreasing(int,double*,short*,int);
static double thickZ(int,int,int,int,int,int,int,int,int,int,double,double,double,double);
static void RecalcFilters(double,short*,double*,int,int,int,int,int,int,double,double,double,double, char *, char *, char *, char *);


/* Variable declarations */
struct seqg_vars {
# line 40 "../pf4.st"
	int b1;
# line 41 "../pf4.st"
	int b2;
# line 42 "../pf4.st"
	int b3;
# line 43 "../pf4.st"
	int b4;
# line 44 "../pf4.st"
	double monoenergy;
# line 46 "../pf4.st"
	int displayBit1;
# line 47 "../pf4.st"
	int displayBit2;
# line 48 "../pf4.st"
	int displayBit3;
# line 49 "../pf4.st"
	int displayBit4;
# line 50 "../pf4.st"
	double displayEnergy;
# line 56 "../pf4.st"
	int selectenergy;
# line 57 "../pf4.st"
	double localenergy;
# line 60 "../pf4.st"
	double filterAl;
# line 61 "../pf4.st"
	double filterTi;
# line 62 "../pf4.st"
	double filterGl;
# line 68 "../pf4.st"
	double trans;
# line 69 "../pf4.st"
	double invtrans;
# line 70 "../pf4.st"
	int debug_flag;
# line 73 "../pf4.st"
	int bitflg;
# line 74 "../pf4.st"
	short bitsts;
# line 75 "../pf4.st"
	short bankctl;
# line 77 "../pf4.st"
	short filpos;
# line 78 "../pf4.st"
	string a00;
# line 79 "../pf4.st"
	string a01;
# line 80 "../pf4.st"
	string a02;
# line 81 "../pf4.st"
	string a03;
# line 82 "../pf4.st"
	string a04;
# line 83 "../pf4.st"
	string a05;
# line 84 "../pf4.st"
	string a06;
# line 85 "../pf4.st"
	string a07;
# line 86 "../pf4.st"
	string a08;
# line 87 "../pf4.st"
	string a09;
# line 88 "../pf4.st"
	string a10;
# line 89 "../pf4.st"
	string a11;
# line 90 "../pf4.st"
	string a12;
# line 91 "../pf4.st"
	string a13;
# line 92 "../pf4.st"
	string a14;
# line 93 "../pf4.st"
	string a15;
# line 96 "../pf4.st"
	double f1;
# line 97 "../pf4.st"
	double f2;
# line 98 "../pf4.st"
	double f3;
# line 99 "../pf4.st"
	double f4;
# line 102 "../pf4.st"
	short z1;
# line 103 "../pf4.st"
	short z2;
# line 104 "../pf4.st"
	short z3;
# line 105 "../pf4.st"
	short z4;
# line 107 "../pf4.st"
	string other1;
# line 108 "../pf4.st"
	string other2;
# line 109 "../pf4.st"
	string other3;
# line 110 "../pf4.st"
	string other4;
# line 111 "../pf4.st"
	string otherShow;
# line 112 "../pf4.st"
	float showEnergy[300];
# line 114 "../pf4.st"
	float showTransmission[300];
# line 116 "../pf4.st"
	int numShow;
# line 118 "../pf4.st"
	short otherLegal1;
# line 119 "../pf4.st"
	short otherLegal2;
# line 120 "../pf4.st"
	short otherLegal3;
# line 121 "../pf4.st"
	short otherLegal4;
# line 123 "../pf4.st"
	char msg[256];
# line 124 "../pf4.st"
	char *SNLtaskName;
# line 125 "../pf4.st"
	short bits[16];
# line 126 "../pf4.st"
	double xmit[16];
# line 127 "../pf4.st"
	double energytimeout;
};


/* Function declarations */

#define seqg_var (*(struct seqg_vars *const *)seqg_env)

/* Program init func */
static void seqg_init(PROG_ID seqg_env)
{
}

/****** Code for state "init" in state set "pf4" ******/

/* Event function for state "init" in state set "pf4" */
static seqBool seqg_event_pf4_0_init(SS_ID seqg_env, int *seqg_ptrn, int *seqg_pnst)
{
	if (TRUE)
	{
		*seqg_pnst = 6;
		*seqg_ptrn = 0;
		return TRUE;
	}
	return FALSE;
}

/* Action function for state "init" in state set "pf4" */
static void seqg_action_pf4_0_init(SS_ID seqg_env, int seqg_trn, int *seqg_pnst)
{
	switch(seqg_trn)
	{
	case 0:
		{
# line 150 "../pf4.st"
			seqg_var->energytimeout = 0.0;
# line 151 "../pf4.st"
			seqg_var->SNLtaskName = seq_macValueGet(seqg_env, "name");
# line 153 "../pf4.st"
			seq_pvGetTmo(seqg_env, 0/*b1*/, SYNC, DEFAULT_TIMEOUT);
			{
# line 153 "../pf4.st"
				seqg_var->displayBit1 = (seqg_var->b1);
# line 153 "../pf4.st"
				seq_pvPutTmo(seqg_env, 5/*displayBit1*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 153 "../pf4.st"
			;
# line 154 "../pf4.st"
			seq_pvGetTmo(seqg_env, 1/*b2*/, SYNC, DEFAULT_TIMEOUT);
			{
# line 154 "../pf4.st"
				seqg_var->displayBit2 = (seqg_var->b2);
# line 154 "../pf4.st"
				seq_pvPutTmo(seqg_env, 6/*displayBit2*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 154 "../pf4.st"
			;
# line 155 "../pf4.st"
			seq_pvGetTmo(seqg_env, 2/*b3*/, SYNC, DEFAULT_TIMEOUT);
			{
# line 155 "../pf4.st"
				seqg_var->displayBit3 = (seqg_var->b3);
# line 155 "../pf4.st"
				seq_pvPutTmo(seqg_env, 7/*displayBit3*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 155 "../pf4.st"
			;
# line 156 "../pf4.st"
			seq_pvGetTmo(seqg_env, 3/*b4*/, SYNC, DEFAULT_TIMEOUT);
			{
# line 156 "../pf4.st"
				seqg_var->displayBit4 = (seqg_var->b4);
# line 156 "../pf4.st"
				seq_pvPutTmo(seqg_env, 8/*displayBit4*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 156 "../pf4.st"
			;
# line 157 "../pf4.st"
			seq_pvGetTmo(seqg_env, 21/*filpos*/, SYNC, DEFAULT_TIMEOUT);
# line 158 "../pf4.st"
			seq_pvGetTmo(seqg_env, 20/*bankctl*/, SYNC, DEFAULT_TIMEOUT);
# line 159 "../pf4.st"
			seq_pvGetTmo(seqg_env, 4/*monoenergy*/, SYNC, DEFAULT_TIMEOUT);
			{
# line 159 "../pf4.st"
				seqg_var->displayEnergy = (seqg_var->monoenergy);
# line 159 "../pf4.st"
				seq_pvPutTmo(seqg_env, 9/*displayEnergy*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 159 "../pf4.st"
			;
# line 160 "../pf4.st"
			seq_pvGetTmo(seqg_env, 17/*debug_flag*/, SYNC, DEFAULT_TIMEOUT);
# line 162 "../pf4.st"
			seq_pvGetTmo(seqg_env, 38/*f1*/, SYNC, DEFAULT_TIMEOUT);
# line 163 "../pf4.st"
			seq_pvGetTmo(seqg_env, 39/*f2*/, SYNC, DEFAULT_TIMEOUT);
# line 164 "../pf4.st"
			seq_pvGetTmo(seqg_env, 40/*f3*/, SYNC, DEFAULT_TIMEOUT);
# line 165 "../pf4.st"
			seq_pvGetTmo(seqg_env, 41/*f4*/, SYNC, DEFAULT_TIMEOUT);
# line 167 "../pf4.st"
			seq_pvGetTmo(seqg_env, 42/*z1*/, SYNC, DEFAULT_TIMEOUT);
# line 168 "../pf4.st"
			seq_pvGetTmo(seqg_env, 43/*z2*/, SYNC, DEFAULT_TIMEOUT);
# line 169 "../pf4.st"
			seq_pvGetTmo(seqg_env, 44/*z3*/, SYNC, DEFAULT_TIMEOUT);
# line 170 "../pf4.st"
			seq_pvGetTmo(seqg_env, 45/*z4*/, SYNC, DEFAULT_TIMEOUT);
			{
# line 172 "../pf4.st"
				seqg_var->localenergy = (seqg_var->monoenergy);
# line 172 "../pf4.st"
				seq_pvPutTmo(seqg_env, 11/*localenergy*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 172 "../pf4.st"
			;
# line 174 "../pf4.st"
			seq_efClear(seqg_env, b1_mon);
# line 175 "../pf4.st"
			seq_efClear(seqg_env, b2_mon);
# line 176 "../pf4.st"
			seq_efClear(seqg_env, b3_mon);
# line 177 "../pf4.st"
			seq_efClear(seqg_env, b4_mon);
# line 179 "../pf4.st"
			seq_efClear(seqg_env, f1_mon);
# line 180 "../pf4.st"
			seq_efClear(seqg_env, f2_mon);
# line 181 "../pf4.st"
			seq_efClear(seqg_env, f3_mon);
# line 182 "../pf4.st"
			seq_efClear(seqg_env, f4_mon);
# line 184 "../pf4.st"
			seq_efClear(seqg_env, z1_mon);
# line 185 "../pf4.st"
			seq_efClear(seqg_env, z2_mon);
# line 186 "../pf4.st"
			seq_efClear(seqg_env, z3_mon);
# line 187 "../pf4.st"
			seq_efClear(seqg_env, z4_mon);
# line 189 "../pf4.st"
			seq_efClear(seqg_env, filpos_mon);
# line 190 "../pf4.st"
			seq_efClear(seqg_env, bankctl_mon);
# line 191 "../pf4.st"
			seq_efClear(seqg_env, selectenergy_mon);
# line 192 "../pf4.st"
			seq_efClear(seqg_env, localenergy_mon);
# line 193 "../pf4.st"
			seq_efClear(seqg_env, monoenergy_mon);
# line 194 "../pf4.st"
			seq_efClear(seqg_env, debug_flag_mon);
# line 195 "../pf4.st"
			if (seqg_var->debug_flag >= 2)
			{
# line 195 "../pf4.st"
				printf("<%s,%d,%s,%d> ", "../pf4.st", 195, seqg_var->SNLtaskName, 2);
# line 195 "../pf4.st"
				;
# line 195 "../pf4.st"
				printf("%s\n", "init complete");
# line 195 "../pf4.st"
				epicsThreadSleep(0.01);
			}
# line 195 "../pf4.st"
			;
		}
		return;
	}
}

/****** Code for state "filterBits" in state set "pf4" ******/

/* Event function for state "filterBits" in state set "pf4" */
static seqBool seqg_event_pf4_0_filterBits(SS_ID seqg_env, int *seqg_ptrn, int *seqg_pnst)
{
	if (TRUE)
	{
		*seqg_pnst = 6;
		*seqg_ptrn = 0;
		return TRUE;
	}
	return FALSE;
}

/* Action function for state "filterBits" in state set "pf4" */
static void seqg_action_pf4_0_filterBits(SS_ID seqg_env, int seqg_trn, int *seqg_pnst)
{
	switch(seqg_trn)
	{
	case 0:
		{
			{
# line 205 "../pf4.st"
				seqg_var->displayBit1 = (seqg_var->b1);
# line 205 "../pf4.st"
				seq_pvPutTmo(seqg_env, 5/*displayBit1*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 205 "../pf4.st"
			;
			{
# line 206 "../pf4.st"
				seqg_var->displayBit2 = (seqg_var->b2);
# line 206 "../pf4.st"
				seq_pvPutTmo(seqg_env, 6/*displayBit2*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 206 "../pf4.st"
			;
			{
# line 207 "../pf4.st"
				seqg_var->displayBit3 = (seqg_var->b3);
# line 207 "../pf4.st"
				seq_pvPutTmo(seqg_env, 7/*displayBit3*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 207 "../pf4.st"
			;
			{
# line 208 "../pf4.st"
				seqg_var->displayBit4 = (seqg_var->b4);
# line 208 "../pf4.st"
				seq_pvPutTmo(seqg_env, 8/*displayBit4*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 208 "../pf4.st"
			;
			{
# line 210 "../pf4.st"
				seqg_var->filpos = (numInArray(16, seqg_var->bits, ((seqg_var->b4 << 3) | (seqg_var->b3 << 2) | (seqg_var->b2 << 1) | seqg_var->b1)));
# line 210 "../pf4.st"
				seq_pvPutTmo(seqg_env, 21/*filpos*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 210 "../pf4.st"
			;
			{
# line 211 "../pf4.st"
				seqg_var->bitflg = ((1 << seqg_var->filpos));
# line 211 "../pf4.st"
				seq_pvPutTmo(seqg_env, 18/*bitflg*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 211 "../pf4.st"
			;
			{
# line 212 "../pf4.st"
				seqg_var->bitsts = (seqg_var->bits[seqg_var->filpos]);
# line 212 "../pf4.st"
				seq_pvPutTmo(seqg_env, 19/*bitsts*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 212 "../pf4.st"
			;
# line 214 "../pf4.st"
			seqg_var->bankctl = (seqg_var->bankctl) ? 2 : 0;
# line 215 "../pf4.st"
			seq_pvPutTmo(seqg_env, 20/*bankctl*/, SYNC, DEFAULT_TIMEOUT);
# line 217 "../pf4.st"
			seq_efClear(seqg_env, filpos_mon);
		}
		return;
	}
}

/****** Code for state "filterPos" in state set "pf4" ******/

/* Event function for state "filterPos" in state set "pf4" */
static seqBool seqg_event_pf4_0_filterPos(SS_ID seqg_env, int *seqg_ptrn, int *seqg_pnst)
{
	if (TRUE)
	{
		*seqg_pnst = 3;
		*seqg_ptrn = 0;
		return TRUE;
	}
	return FALSE;
}

/* Action function for state "filterPos" in state set "pf4" */
static void seqg_action_pf4_0_filterPos(SS_ID seqg_env, int seqg_trn, int *seqg_pnst)
{
	switch(seqg_trn)
	{
	case 0:
		{
# line 227 "../pf4.st"
			if (seqg_var->bits[seqg_var->filpos] & 0x1)
			{
				{
# line 227 "../pf4.st"
					seqg_var->b1 = (1);
# line 227 "../pf4.st"
					seq_pvPutTmo(seqg_env, 0/*b1*/, SYNC, DEFAULT_TIMEOUT);
				}
# line 227 "../pf4.st"
				;
				{
# line 227 "../pf4.st"
					seqg_var->displayBit1 = (1);
# line 227 "../pf4.st"
					seq_pvPutTmo(seqg_env, 5/*displayBit1*/, SYNC, DEFAULT_TIMEOUT);
				}
# line 227 "../pf4.st"
				;
			}
# line 228 "../pf4.st"
			if (seqg_var->bits[seqg_var->filpos] & 0x2)
			{
				{
# line 228 "../pf4.st"
					seqg_var->b2 = (1);
# line 228 "../pf4.st"
					seq_pvPutTmo(seqg_env, 1/*b2*/, SYNC, DEFAULT_TIMEOUT);
				}
# line 228 "../pf4.st"
				;
				{
# line 228 "../pf4.st"
					seqg_var->displayBit2 = (1);
# line 228 "../pf4.st"
					seq_pvPutTmo(seqg_env, 6/*displayBit2*/, SYNC, DEFAULT_TIMEOUT);
				}
# line 228 "../pf4.st"
				;
			}
# line 229 "../pf4.st"
			if (seqg_var->bits[seqg_var->filpos] & 0x4)
			{
				{
# line 229 "../pf4.st"
					seqg_var->b3 = (1);
# line 229 "../pf4.st"
					seq_pvPutTmo(seqg_env, 2/*b3*/, SYNC, DEFAULT_TIMEOUT);
				}
# line 229 "../pf4.st"
				;
				{
# line 229 "../pf4.st"
					seqg_var->displayBit3 = (1);
# line 229 "../pf4.st"
					seq_pvPutTmo(seqg_env, 7/*displayBit3*/, SYNC, DEFAULT_TIMEOUT);
				}
# line 229 "../pf4.st"
				;
			}
# line 230 "../pf4.st"
			if (seqg_var->bits[seqg_var->filpos] & 0x8)
			{
				{
# line 230 "../pf4.st"
					seqg_var->b4 = (1);
# line 230 "../pf4.st"
					seq_pvPutTmo(seqg_env, 3/*b4*/, SYNC, DEFAULT_TIMEOUT);
				}
# line 230 "../pf4.st"
				;
				{
# line 230 "../pf4.st"
					seqg_var->displayBit4 = (1);
# line 230 "../pf4.st"
					seq_pvPutTmo(seqg_env, 8/*displayBit4*/, SYNC, DEFAULT_TIMEOUT);
				}
# line 230 "../pf4.st"
				;
			}
# line 233 "../pf4.st"
			epicsThreadSleep((0.20));
# line 236 "../pf4.st"
			if (!(seqg_var->bits[seqg_var->filpos] & 0x1))
			{
				{
# line 236 "../pf4.st"
					seqg_var->b1 = (0);
# line 236 "../pf4.st"
					seq_pvPutTmo(seqg_env, 0/*b1*/, SYNC, DEFAULT_TIMEOUT);
				}
# line 236 "../pf4.st"
				;
				{
# line 236 "../pf4.st"
					seqg_var->displayBit1 = (0);
# line 236 "../pf4.st"
					seq_pvPutTmo(seqg_env, 5/*displayBit1*/, SYNC, DEFAULT_TIMEOUT);
				}
# line 236 "../pf4.st"
				;
			}
# line 237 "../pf4.st"
			if (!(seqg_var->bits[seqg_var->filpos] & 0x2))
			{
				{
# line 237 "../pf4.st"
					seqg_var->b2 = (0);
# line 237 "../pf4.st"
					seq_pvPutTmo(seqg_env, 1/*b2*/, SYNC, DEFAULT_TIMEOUT);
				}
# line 237 "../pf4.st"
				;
				{
# line 237 "../pf4.st"
					seqg_var->displayBit2 = (0);
# line 237 "../pf4.st"
					seq_pvPutTmo(seqg_env, 6/*displayBit2*/, SYNC, DEFAULT_TIMEOUT);
				}
# line 237 "../pf4.st"
				;
			}
# line 238 "../pf4.st"
			if (!(seqg_var->bits[seqg_var->filpos] & 0x4))
			{
				{
# line 238 "../pf4.st"
					seqg_var->b3 = (0);
# line 238 "../pf4.st"
					seq_pvPutTmo(seqg_env, 2/*b3*/, SYNC, DEFAULT_TIMEOUT);
				}
# line 238 "../pf4.st"
				;
				{
# line 238 "../pf4.st"
					seqg_var->displayBit3 = (0);
# line 238 "../pf4.st"
					seq_pvPutTmo(seqg_env, 7/*displayBit3*/, SYNC, DEFAULT_TIMEOUT);
				}
# line 238 "../pf4.st"
				;
			}
# line 239 "../pf4.st"
			if (!(seqg_var->bits[seqg_var->filpos] & 0x8))
			{
				{
# line 239 "../pf4.st"
					seqg_var->b4 = (0);
# line 239 "../pf4.st"
					seq_pvPutTmo(seqg_env, 3/*b4*/, SYNC, DEFAULT_TIMEOUT);
				}
# line 239 "../pf4.st"
				;
				{
# line 239 "../pf4.st"
					seqg_var->displayBit4 = (0);
# line 239 "../pf4.st"
					seq_pvPutTmo(seqg_env, 8/*displayBit4*/, SYNC, DEFAULT_TIMEOUT);
				}
# line 239 "../pf4.st"
				;
			}
			{
# line 241 "../pf4.st"
				seqg_var->bitflg = ((1 << seqg_var->filpos));
# line 241 "../pf4.st"
				seq_pvPutTmo(seqg_env, 18/*bitflg*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 241 "../pf4.st"
			;
			{
# line 242 "../pf4.st"
				seqg_var->bitsts = (seqg_var->bits[seqg_var->filpos]);
# line 242 "../pf4.st"
				seq_pvPutTmo(seqg_env, 19/*bitsts*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 242 "../pf4.st"
			;
# line 244 "../pf4.st"
			seq_efClear(seqg_env, b1_mon);
# line 245 "../pf4.st"
			seq_efClear(seqg_env, b2_mon);
# line 246 "../pf4.st"
			seq_efClear(seqg_env, b3_mon);
# line 247 "../pf4.st"
			seq_efClear(seqg_env, b4_mon);
		}
		return;
	}
}

/****** Code for state "recalcBank" in state set "pf4" ******/

/* Event function for state "recalcBank" in state set "pf4" */
static seqBool seqg_event_pf4_0_recalcBank(SS_ID seqg_env, int *seqg_ptrn, int *seqg_pnst)
{
	if (TRUE)
	{
		*seqg_pnst = 6;
		*seqg_ptrn = 0;
		return TRUE;
	}
	return FALSE;
}

/* Action function for state "recalcBank" in state set "pf4" */
static void seqg_action_pf4_0_recalcBank(SS_ID seqg_env, int seqg_trn, int *seqg_pnst)
{
	switch(seqg_trn)
	{
	case 0:
		{
# line 256 "../pf4.st"
			if (seqg_var->debug_flag >= 2)
			{
# line 256 "../pf4.st"
				printf("<%s,%d,%s,%d> ", "../pf4.st", 256, seqg_var->SNLtaskName, 2);
# line 256 "../pf4.st"
				;
# line 256 "../pf4.st"
				printf("%s\n", "recalcBank");
# line 256 "../pf4.st"
				epicsThreadSleep(0.01);
			}
# line 256 "../pf4.st"
			;
# line 258 "../pf4.st"
			seqg_var->bankctl = (seqg_var->bankctl) ? 3 : 0;
# line 259 "../pf4.st"
			seq_pvPutTmo(seqg_env, 20/*bankctl*/, SYNC, DEFAULT_TIMEOUT);
		}
		return;
	}
}

/****** Code for state "bankControl" in state set "pf4" ******/

/* Event function for state "bankControl" in state set "pf4" */
static seqBool seqg_event_pf4_0_bankControl(SS_ID seqg_env, int *seqg_ptrn, int *seqg_pnst)
{
# line 265 "../pf4.st"
	if (seqg_var->bankctl == 0)
	{
		*seqg_pnst = 5;
		*seqg_ptrn = 0;
		return TRUE;
	}
	if (TRUE)
	{
		*seqg_pnst = 6;
		*seqg_ptrn = 1;
		return TRUE;
	}
	return FALSE;
}

/* Action function for state "bankControl" in state set "pf4" */
static void seqg_action_pf4_0_bankControl(SS_ID seqg_env, int seqg_trn, int *seqg_pnst)
{
	switch(seqg_trn)
	{
	case 0:
		{
# line 267 "../pf4.st"
			sprintf(seqg_var->msg, "filter bank switched off (%d)", seqg_var->bankctl);
# line 268 "../pf4.st"
			if (seqg_var->debug_flag >= 2)
			{
# line 268 "../pf4.st"
				printf("<%s,%d,%s,%d> ", "../pf4.st", 268, seqg_var->SNLtaskName, 2);
# line 268 "../pf4.st"
				;
# line 268 "../pf4.st"
				printf("%s\n", seqg_var->msg);
# line 268 "../pf4.st"
				epicsThreadSleep(0.01);
			}
# line 268 "../pf4.st"
			;
		}
		return;
	case 1:
		{
# line 273 "../pf4.st"
			if (seqg_var->bankctl == 1)
# line 274 "../pf4.st"
				sprintf(seqg_var->msg, "filter bank changed value to %d", seqg_var->bankctl);
			else
# line 275 "../pf4.st"
				if (seqg_var->bankctl == 2)
				{
# line 277 "../pf4.st"
					if (seqg_var->z1 == 0 || seqg_var->z2 == 0 || seqg_var->z3 == 0 || seqg_var->z4 == 0)
					{
# line 277 "../pf4.st"
						seqg_var->filterAl = (thickZ(0, seqg_var->bankctl, seqg_var->b1, seqg_var->b2, seqg_var->b3, seqg_var->b4, seqg_var->z1, seqg_var->z2, seqg_var->z3, seqg_var->z4, seqg_var->f1, seqg_var->f2, seqg_var->f3, seqg_var->f4));
# line 277 "../pf4.st"
						seq_pvPutTmo(seqg_env, 12/*filterAl*/, SYNC, DEFAULT_TIMEOUT);
					}
# line 277 "../pf4.st"
					;
# line 278 "../pf4.st"
					if (seqg_var->z1 == 1 || seqg_var->z2 == 1 || seqg_var->z3 == 1 || seqg_var->z4 == 1)
					{
# line 278 "../pf4.st"
						seqg_var->filterTi = (thickZ(1, seqg_var->bankctl, seqg_var->b1, seqg_var->b2, seqg_var->b3, seqg_var->b4, seqg_var->z1, seqg_var->z2, seqg_var->z3, seqg_var->z4, seqg_var->f1, seqg_var->f2, seqg_var->f3, seqg_var->f4));
# line 278 "../pf4.st"
						seq_pvPutTmo(seqg_env, 13/*filterTi*/, SYNC, DEFAULT_TIMEOUT);
					}
# line 278 "../pf4.st"
					;
# line 279 "../pf4.st"
					if (seqg_var->z1 == 2 || seqg_var->z2 == 2 || seqg_var->z3 == 2 || seqg_var->z4 == 2)
					{
# line 279 "../pf4.st"
						seqg_var->filterGl = (thickZ(2, seqg_var->bankctl, seqg_var->b1, seqg_var->b2, seqg_var->b3, seqg_var->b4, seqg_var->z1, seqg_var->z2, seqg_var->z3, seqg_var->z4, seqg_var->f1, seqg_var->f2, seqg_var->f3, seqg_var->f4));
# line 279 "../pf4.st"
						seq_pvPutTmo(seqg_env, 14/*filterGl*/, SYNC, DEFAULT_TIMEOUT);
					}
# line 279 "../pf4.st"
					;
					{
# line 281 "../pf4.st"
						seqg_var->trans = (seqg_var->xmit[seqg_var->filpos]);
# line 281 "../pf4.st"
						seq_pvPutTmo(seqg_env, 15/*trans*/, SYNC, DEFAULT_TIMEOUT);
					}
# line 281 "../pf4.st"
					;
# line 282 "../pf4.st"
					if (seqg_var->trans > 0.0)
					{
# line 282 "../pf4.st"
						seqg_var->invtrans = (1 / seqg_var->trans);
# line 282 "../pf4.st"
						seq_pvPutTmo(seqg_env, 16/*invtrans*/, SYNC, DEFAULT_TIMEOUT);
					}
# line 282 "../pf4.st"
					;
					{
# line 284 "../pf4.st"
						seqg_var->bitsts = (seqg_var->bits[seqg_var->filpos]);
# line 284 "../pf4.st"
						seq_pvPutTmo(seqg_env, 19/*bitsts*/, SYNC, DEFAULT_TIMEOUT);
					}
# line 284 "../pf4.st"
					;
					{
# line 285 "../pf4.st"
						seqg_var->bitflg = ((1 << seqg_var->filpos));
# line 285 "../pf4.st"
						seq_pvPutTmo(seqg_env, 18/*bitflg*/, SYNC, DEFAULT_TIMEOUT);
					}
# line 285 "../pf4.st"
					;
# line 287 "../pf4.st"
					seqg_var->bankctl = (seqg_var->bankctl) ? 1 : 0;
# line 288 "../pf4.st"
					seq_pvPutTmo(seqg_env, 20/*bankctl*/, SYNC, DEFAULT_TIMEOUT);
# line 290 "../pf4.st"
					sprintf(seqg_var->msg, "filter bank changed value to %d", seqg_var->bankctl);
				}
				else
# line 292 "../pf4.st"
					if (seqg_var->bankctl == 3)
					{
# line 294 "../pf4.st"
						seq_pvGetTmo(seqg_env, 11/*localenergy*/, SYNC, DEFAULT_TIMEOUT);
# line 295 "../pf4.st"
						seq_efClear(seqg_env, localenergy_mon);
# line 296 "../pf4.st"
						RecalcFilters(seqg_var->localenergy, seqg_var->bits, seqg_var->xmit, seqg_var->debug_flag, seqg_var->bankctl, seqg_var->z1, seqg_var->z2, seqg_var->z3, seqg_var->z4, seqg_var->f1, seqg_var->f2, seqg_var->f3, seqg_var->f4, seqg_var->other1, seqg_var->other2, seqg_var->other3, seqg_var->other4);
# line 299 "../pf4.st"
						sprintf(seqg_var->a00, "%.3e", seqg_var->xmit[0]);
# line 299 "../pf4.st"
						seq_pvPutTmo(seqg_env, 22/*a00*/, SYNC, DEFAULT_TIMEOUT);
# line 300 "../pf4.st"
						sprintf(seqg_var->a01, "%.3e", seqg_var->xmit[1]);
# line 300 "../pf4.st"
						seq_pvPutTmo(seqg_env, 23/*a01*/, SYNC, DEFAULT_TIMEOUT);
# line 301 "../pf4.st"
						sprintf(seqg_var->a02, "%.3e", seqg_var->xmit[2]);
# line 301 "../pf4.st"
						seq_pvPutTmo(seqg_env, 24/*a02*/, SYNC, DEFAULT_TIMEOUT);
# line 302 "../pf4.st"
						sprintf(seqg_var->a03, "%.3e", seqg_var->xmit[3]);
# line 302 "../pf4.st"
						seq_pvPutTmo(seqg_env, 25/*a03*/, SYNC, DEFAULT_TIMEOUT);
# line 303 "../pf4.st"
						sprintf(seqg_var->a04, "%.3e", seqg_var->xmit[4]);
# line 303 "../pf4.st"
						seq_pvPutTmo(seqg_env, 26/*a04*/, SYNC, DEFAULT_TIMEOUT);
# line 304 "../pf4.st"
						sprintf(seqg_var->a05, "%.3e", seqg_var->xmit[5]);
# line 304 "../pf4.st"
						seq_pvPutTmo(seqg_env, 27/*a05*/, SYNC, DEFAULT_TIMEOUT);
# line 305 "../pf4.st"
						sprintf(seqg_var->a06, "%.3e", seqg_var->xmit[6]);
# line 305 "../pf4.st"
						seq_pvPutTmo(seqg_env, 28/*a06*/, SYNC, DEFAULT_TIMEOUT);
# line 306 "../pf4.st"
						sprintf(seqg_var->a07, "%.3e", seqg_var->xmit[7]);
# line 306 "../pf4.st"
						seq_pvPutTmo(seqg_env, 29/*a07*/, SYNC, DEFAULT_TIMEOUT);
# line 307 "../pf4.st"
						sprintf(seqg_var->a08, "%.3e", seqg_var->xmit[8]);
# line 307 "../pf4.st"
						seq_pvPutTmo(seqg_env, 30/*a08*/, SYNC, DEFAULT_TIMEOUT);
# line 308 "../pf4.st"
						sprintf(seqg_var->a09, "%.3e", seqg_var->xmit[9]);
# line 308 "../pf4.st"
						seq_pvPutTmo(seqg_env, 31/*a09*/, SYNC, DEFAULT_TIMEOUT);
# line 309 "../pf4.st"
						sprintf(seqg_var->a10, "%.3e", seqg_var->xmit[10]);
# line 309 "../pf4.st"
						seq_pvPutTmo(seqg_env, 32/*a10*/, SYNC, DEFAULT_TIMEOUT);
# line 310 "../pf4.st"
						sprintf(seqg_var->a11, "%.3e", seqg_var->xmit[11]);
# line 310 "../pf4.st"
						seq_pvPutTmo(seqg_env, 33/*a11*/, SYNC, DEFAULT_TIMEOUT);
# line 311 "../pf4.st"
						sprintf(seqg_var->a12, "%.3e", seqg_var->xmit[12]);
# line 311 "../pf4.st"
						seq_pvPutTmo(seqg_env, 34/*a12*/, SYNC, DEFAULT_TIMEOUT);
# line 312 "../pf4.st"
						sprintf(seqg_var->a13, "%.3e", seqg_var->xmit[13]);
# line 312 "../pf4.st"
						seq_pvPutTmo(seqg_env, 35/*a13*/, SYNC, DEFAULT_TIMEOUT);
# line 313 "../pf4.st"
						sprintf(seqg_var->a14, "%.3e", seqg_var->xmit[14]);
# line 313 "../pf4.st"
						seq_pvPutTmo(seqg_env, 36/*a14*/, SYNC, DEFAULT_TIMEOUT);
# line 314 "../pf4.st"
						sprintf(seqg_var->a15, "%.3e", seqg_var->xmit[15]);
# line 314 "../pf4.st"
						seq_pvPutTmo(seqg_env, 37/*a15*/, SYNC, DEFAULT_TIMEOUT);
						{
# line 316 "../pf4.st"
							seqg_var->bankctl = (2);
# line 316 "../pf4.st"
							seq_pvPutTmo(seqg_env, 20/*bankctl*/, SYNC, DEFAULT_TIMEOUT);
						}
# line 316 "../pf4.st"
						;
# line 317 "../pf4.st"
						sprintf(seqg_var->msg, "filter bank changed value to %d", seqg_var->bankctl);
					}
					else
# line 320 "../pf4.st"
						sprintf(seqg_var->msg, "invalid filter bank value of %d", seqg_var->bankctl);
# line 322 "../pf4.st"
			if (seqg_var->debug_flag >= 2)
			{
# line 322 "../pf4.st"
				printf("<%s,%d,%s,%d> ", "../pf4.st", 322, seqg_var->SNLtaskName, 2);
# line 322 "../pf4.st"
				;
# line 322 "../pf4.st"
				printf("%s\n", seqg_var->msg);
# line 322 "../pf4.st"
				epicsThreadSleep(0.01);
			}
# line 322 "../pf4.st"
			;
		}
		return;
	}
}

/****** Code for state "bankOff" in state set "pf4" ******/

/* Event function for state "bankOff" in state set "pf4" */
static seqBool seqg_event_pf4_0_bankOff(SS_ID seqg_env, int *seqg_ptrn, int *seqg_pnst)
{
# line 328 "../pf4.st"
	if (seqg_var->bankctl)
	{
		*seqg_pnst = 3;
		*seqg_ptrn = 0;
		return TRUE;
	}
# line 340 "../pf4.st"
	if (seq_delay(seqg_env, (0.10)))
	{
		*seqg_pnst = 5;
		*seqg_ptrn = 1;
		return TRUE;
	}
	return FALSE;
}

/* Action function for state "bankOff" in state set "pf4" */
static void seqg_action_pf4_0_bankOff(SS_ID seqg_env, int seqg_trn, int *seqg_pnst)
{
	switch(seqg_trn)
	{
	case 0:
		{
# line 330 "../pf4.st"
			seq_pvGetTmo(seqg_env, 10/*selectenergy*/, SYNC, DEFAULT_TIMEOUT);
# line 331 "../pf4.st"
			seq_pvGetTmo(seqg_env, 11/*localenergy*/, SYNC, DEFAULT_TIMEOUT);
# line 332 "../pf4.st"
			seq_pvGetTmo(seqg_env, 4/*monoenergy*/, SYNC, DEFAULT_TIMEOUT);
			{
# line 332 "../pf4.st"
				seqg_var->displayEnergy = (seqg_var->monoenergy);
# line 332 "../pf4.st"
				seq_pvPutTmo(seqg_env, 9/*displayEnergy*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 332 "../pf4.st"
			;
# line 334 "../pf4.st"
			seq_efClear(seqg_env, localenergy_mon);
# line 336 "../pf4.st"
			sprintf(seqg_var->msg, "filter bank switched on (%d)", seqg_var->bankctl);
# line 337 "../pf4.st"
			if (seqg_var->debug_flag >= 2)
			{
# line 337 "../pf4.st"
				printf("<%s,%d,%s,%d> ", "../pf4.st", 337, seqg_var->SNLtaskName, 2);
# line 337 "../pf4.st"
				;
# line 337 "../pf4.st"
				printf("%s\n", seqg_var->msg);
# line 337 "../pf4.st"
				epicsThreadSleep(0.01);
			}
# line 337 "../pf4.st"
			;
		}
		return;
	case 1:
		{
		}
		return;
	}
}

/****** Code for state "idle" in state set "pf4" ******/

/* Event function for state "idle" in state set "pf4" */
static seqBool seqg_event_pf4_0_idle(SS_ID seqg_env, int *seqg_ptrn, int *seqg_pnst)
{
# line 346 "../pf4.st"
	if (seq_efTestAndClear(seqg_env, debug_flag_mon))
	{
		*seqg_pnst = 6;
		*seqg_ptrn = 0;
		return TRUE;
	}
# line 353 "../pf4.st"
	if (seq_efTestAndClear(seqg_env, localenergy_mon))
	{
		*seqg_pnst = 3;
		*seqg_ptrn = 1;
		return TRUE;
	}
# line 364 "../pf4.st"
	if (seq_efTestAndClear(seqg_env, selectenergy_mon))
	{
		*seqg_pnst = 6;
		*seqg_ptrn = 2;
		return TRUE;
	}
# line 381 "../pf4.st"
	if (seq_efTestAndClear(seqg_env, monoenergy_mon))
	{
		*seqg_pnst = 6;
		*seqg_ptrn = 3;
		return TRUE;
	}
# line 394 "../pf4.st"
	if (seq_efTestAndClear(seqg_env, bankctl_mon))
	{
		*seqg_pnst = 4;
		*seqg_ptrn = 4;
		return TRUE;
	}
# line 401 "../pf4.st"
	if (seq_efTestAndClear(seqg_env, f1_mon) || seq_efTestAndClear(seqg_env, f2_mon) || seq_efTestAndClear(seqg_env, f3_mon) || seq_efTestAndClear(seqg_env, f4_mon))
	{
		*seqg_pnst = 6;
		*seqg_ptrn = 5;
		return TRUE;
	}
# line 412 "../pf4.st"
	if (seq_efTestAndClear(seqg_env, z1_mon) || seq_efTestAndClear(seqg_env, z2_mon) || seq_efTestAndClear(seqg_env, z3_mon) || seq_efTestAndClear(seqg_env, z4_mon))
	{
		*seqg_pnst = 6;
		*seqg_ptrn = 6;
		return TRUE;
	}
# line 424 "../pf4.st"
	if (seq_efTestAndClear(seqg_env, other1_mon) || seq_efTestAndClear(seqg_env, other2_mon) || seq_efTestAndClear(seqg_env, other3_mon) || seq_efTestAndClear(seqg_env, other4_mon))
	{
		*seqg_pnst = 6;
		*seqg_ptrn = 7;
		return TRUE;
	}
# line 438 "../pf4.st"
	if (seq_efTestAndClear(seqg_env, b4_mon) || seq_efTestAndClear(seqg_env, b3_mon) || seq_efTestAndClear(seqg_env, b2_mon) || seq_efTestAndClear(seqg_env, b1_mon))
	{
		*seqg_pnst = 1;
		*seqg_ptrn = 8;
		return TRUE;
	}
# line 447 "../pf4.st"
	if (seq_efTestAndClear(seqg_env, filpos_mon) && seqg_var->bankctl)
	{
		*seqg_pnst = 2;
		*seqg_ptrn = 9;
		return TRUE;
	}
# line 453 "../pf4.st"
	if (seq_delay(seqg_env, (0.10)))
	{
		*seqg_pnst = 6;
		*seqg_ptrn = 10;
		return TRUE;
	}
# line 465 "../pf4.st"
	if (seq_efTestAndClear(seqg_env, otherShow_mon))
	{
		*seqg_pnst = 6;
		*seqg_ptrn = 11;
		return TRUE;
	}
	return FALSE;
}

/* Action function for state "idle" in state set "pf4" */
static void seqg_action_pf4_0_idle(SS_ID seqg_env, int seqg_trn, int *seqg_pnst)
{
	switch(seqg_trn)
	{
	case 0:
		{
# line 348 "../pf4.st"
			sprintf(seqg_var->msg, "Debug level changed to %d", seqg_var->debug_flag);
# line 349 "../pf4.st"
			if (seqg_var->debug_flag >= 1)
			{
# line 349 "../pf4.st"
				printf("<%s,%d,%s,%d> ", "../pf4.st", 349, seqg_var->SNLtaskName, 1);
# line 349 "../pf4.st"
				;
# line 349 "../pf4.st"
				printf("%s\n", seqg_var->msg);
# line 349 "../pf4.st"
				epicsThreadSleep(0.01);
			}
# line 349 "../pf4.st"
			;
		}
		return;
	case 1:
		{
			{
# line 355 "../pf4.st"
				seqg_var->selectenergy = (0);
# line 355 "../pf4.st"
				seq_pvPutTmo(seqg_env, 10/*selectenergy*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 355 "../pf4.st"
			;
# line 356 "../pf4.st"
			epicsThreadSleep((0.01));
# line 357 "../pf4.st"
			seq_efClear(seqg_env, selectenergy_mon);
# line 359 "../pf4.st"
			sprintf(seqg_var->msg, "local energy changed to %f", seqg_var->localenergy);
# line 360 "../pf4.st"
			if (seqg_var->debug_flag >= 2)
			{
# line 360 "../pf4.st"
				printf("<%s,%d,%s,%d> ", "../pf4.st", 360, seqg_var->SNLtaskName, 2);
# line 360 "../pf4.st"
				;
# line 360 "../pf4.st"
				printf("%s\n", seqg_var->msg);
# line 360 "../pf4.st"
				epicsThreadSleep(0.01);
			}
# line 360 "../pf4.st"
			;
		}
		return;
	case 2:
		{
# line 366 "../pf4.st"
			if (seqg_var->selectenergy)
			{
				{
# line 368 "../pf4.st"
					seqg_var->localenergy = (seqg_var->monoenergy);
# line 368 "../pf4.st"
					seq_pvPutTmo(seqg_env, 11/*localenergy*/, SYNC, DEFAULT_TIMEOUT);
				}
# line 368 "../pf4.st"
				;
# line 369 "../pf4.st"
				epicsThreadSleep((0.01));
# line 370 "../pf4.st"
				seq_efClear(seqg_env, localenergy_mon);
# line 372 "../pf4.st"
				seqg_var->bankctl = (seqg_var->bankctl) ? 3 : 0;
# line 373 "../pf4.st"
				seq_pvPutTmo(seqg_env, 20/*bankctl*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 376 "../pf4.st"
			sprintf(seqg_var->msg, "using energy local/monochromator changed to %d", seqg_var->selectenergy);
# line 377 "../pf4.st"
			if (seqg_var->debug_flag >= 2)
			{
# line 377 "../pf4.st"
				printf("<%s,%d,%s,%d> ", "../pf4.st", 377, seqg_var->SNLtaskName, 2);
# line 377 "../pf4.st"
				;
# line 377 "../pf4.st"
				printf("%s\n", seqg_var->msg);
# line 377 "../pf4.st"
				epicsThreadSleep(0.01);
			}
# line 377 "../pf4.st"
			;
		}
		return;
	case 3:
		{
			{
# line 382 "../pf4.st"
				seqg_var->displayEnergy = (seqg_var->monoenergy);
# line 382 "../pf4.st"
				seq_pvPutTmo(seqg_env, 9/*displayEnergy*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 382 "../pf4.st"
			;
# line 383 "../pf4.st"
			if (seqg_var->selectenergy)
			{
				{
# line 384 "../pf4.st"
					seqg_var->localenergy = (seqg_var->monoenergy);
# line 384 "../pf4.st"
					seq_pvPutTmo(seqg_env, 11/*localenergy*/, SYNC, DEFAULT_TIMEOUT);
				}
# line 384 "../pf4.st"
				;
# line 385 "../pf4.st"
				epicsThreadSleep((0.01));
# line 386 "../pf4.st"
				seq_efClear(seqg_env, localenergy_mon);
# line 387 "../pf4.st"
				seqg_var->energytimeout = (1.50);
# line 388 "../pf4.st"
				sprintf(seqg_var->msg, "monochromator energy changed to %f", seqg_var->monoenergy);
# line 389 "../pf4.st"
				if (seqg_var->debug_flag >= 2)
				{
# line 389 "../pf4.st"
					printf("<%s,%d,%s,%d> ", "../pf4.st", 389, seqg_var->SNLtaskName, 2);
# line 389 "../pf4.st"
					;
# line 389 "../pf4.st"
					printf("%s\n", seqg_var->msg);
# line 389 "../pf4.st"
					epicsThreadSleep(0.01);
				}
# line 389 "../pf4.st"
				;
			}
		}
		return;
	case 4:
		{
# line 396 "../pf4.st"
			sprintf(seqg_var->msg, "filter bank changed to %d, going to state bankControl", seqg_var->bankctl);
# line 397 "../pf4.st"
			if (seqg_var->debug_flag >= 2)
			{
# line 397 "../pf4.st"
				printf("<%s,%d,%s,%d> ", "../pf4.st", 397, seqg_var->SNLtaskName, 2);
# line 397 "../pf4.st"
				;
# line 397 "../pf4.st"
				printf("%s\n", seqg_var->msg);
# line 397 "../pf4.st"
				epicsThreadSleep(0.01);
			}
# line 397 "../pf4.st"
			;
		}
		return;
	case 5:
		{
# line 404 "../pf4.st"
			sprintf(seqg_var->msg, "filters thickness changed to f1=%g, f2=%g, f3=%g, f3=%g", seqg_var->f1, seqg_var->f2, seqg_var->f3, seqg_var->f4);
# line 405 "../pf4.st"
			if (seqg_var->debug_flag >= 2)
			{
# line 405 "../pf4.st"
				printf("<%s,%d,%s,%d> ", "../pf4.st", 405, seqg_var->SNLtaskName, 2);
# line 405 "../pf4.st"
				;
# line 405 "../pf4.st"
				printf("%s\n", seqg_var->msg);
# line 405 "../pf4.st"
				epicsThreadSleep(0.01);
			}
# line 405 "../pf4.st"
			;
# line 407 "../pf4.st"
			seqg_var->bankctl = (seqg_var->bankctl) ? 3 : 0;
# line 408 "../pf4.st"
			seq_pvPutTmo(seqg_env, 20/*bankctl*/, SYNC, DEFAULT_TIMEOUT);
		}
		return;
	case 6:
		{
# line 415 "../pf4.st"
			sprintf(seqg_var->msg, "filters material index changed to z1=%d, z2=%d, z3=%d, z4=%d", seqg_var->z1, seqg_var->z2, seqg_var->z3, seqg_var->z4);
# line 416 "../pf4.st"
			if (seqg_var->debug_flag >= 2)
			{
# line 416 "../pf4.st"
				printf("<%s,%d,%s,%d> ", "../pf4.st", 416, seqg_var->SNLtaskName, 2);
# line 416 "../pf4.st"
				;
# line 416 "../pf4.st"
				printf("%s\n", seqg_var->msg);
# line 416 "../pf4.st"
				epicsThreadSleep(0.01);
			}
# line 416 "../pf4.st"
			;
# line 418 "../pf4.st"
			seqg_var->bankctl = (seqg_var->bankctl) ? 3 : 0;
# line 419 "../pf4.st"
			seq_pvPutTmo(seqg_env, 20/*bankctl*/, SYNC, DEFAULT_TIMEOUT);
		}
		return;
	case 7:
		{
# line 427 "../pf4.st"
			sprintf(seqg_var->msg, "filters material index changed to other1='%s', o2='%s', o3='%s', o4='%s'", seqg_var->other1, seqg_var->other2, seqg_var->other3, seqg_var->other4);
# line 428 "../pf4.st"
			if (seqg_var->debug_flag >= 2)
			{
# line 428 "../pf4.st"
				printf("<%s,%d,%s,%d> ", "../pf4.st", 428, seqg_var->SNLtaskName, 2);
# line 428 "../pf4.st"
				;
# line 428 "../pf4.st"
				printf("%s\n", seqg_var->msg);
# line 428 "../pf4.st"
				epicsThreadSleep(0.01);
			}
# line 428 "../pf4.st"
			;
			{
# line 429 "../pf4.st"
				seqg_var->otherLegal1 = (isLegalOther(seqg_var->other1));
# line 429 "../pf4.st"
				seq_pvPutTmo(seqg_env, 54/*otherLegal1*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 429 "../pf4.st"
			;
			{
# line 430 "../pf4.st"
				seqg_var->otherLegal2 = (isLegalOther(seqg_var->other2));
# line 430 "../pf4.st"
				seq_pvPutTmo(seqg_env, 55/*otherLegal2*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 430 "../pf4.st"
			;
			{
# line 431 "../pf4.st"
				seqg_var->otherLegal3 = (isLegalOther(seqg_var->other3));
# line 431 "../pf4.st"
				seq_pvPutTmo(seqg_env, 56/*otherLegal3*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 431 "../pf4.st"
			;
			{
# line 432 "../pf4.st"
				seqg_var->otherLegal4 = (isLegalOther(seqg_var->other4));
# line 432 "../pf4.st"
				seq_pvPutTmo(seqg_env, 57/*otherLegal4*/, SYNC, DEFAULT_TIMEOUT);
			}
# line 432 "../pf4.st"
			;
# line 433 "../pf4.st"
			seqg_var->bankctl = (seqg_var->bankctl) ? 3 : 0;
# line 434 "../pf4.st"
			seq_pvPutTmo(seqg_env, 20/*bankctl*/, SYNC, DEFAULT_TIMEOUT);
		}
		return;
	case 8:
		{
# line 442 "../pf4.st"
			sprintf(seqg_var->msg, "filter bits changed to (%1.1d%1.1d%1.1d%1.1d), going to state filterBits", seqg_var->b4, seqg_var->b3, seqg_var->b2, seqg_var->b1);
# line 443 "../pf4.st"
			if (seqg_var->debug_flag >= 2)
			{
# line 443 "../pf4.st"
				printf("<%s,%d,%s,%d> ", "../pf4.st", 443, seqg_var->SNLtaskName, 2);
# line 443 "../pf4.st"
				;
# line 443 "../pf4.st"
				printf("%s\n", seqg_var->msg);
# line 443 "../pf4.st"
				epicsThreadSleep(0.01);
			}
# line 443 "../pf4.st"
			;
		}
		return;
	case 9:
		{
# line 449 "../pf4.st"
			sprintf(seqg_var->msg, "filter position changed to %d, going to state filterPos", seqg_var->filpos);
# line 450 "../pf4.st"
			if (seqg_var->debug_flag >= 2)
			{
# line 450 "../pf4.st"
				printf("<%s,%d,%s,%d> ", "../pf4.st", 450, seqg_var->SNLtaskName, 2);
# line 450 "../pf4.st"
				;
# line 450 "../pf4.st"
				printf("%s\n", seqg_var->msg);
# line 450 "../pf4.st"
				epicsThreadSleep(0.01);
			}
# line 450 "../pf4.st"
			;
		}
		return;
	case 10:
		{
# line 455 "../pf4.st"
			if (seqg_var->energytimeout > 0.0 && (seqg_var->energytimeout = seqg_var->energytimeout - (0.10)) <= 0.0)
			{
# line 457 "../pf4.st"
				seqg_var->bankctl = (seqg_var->bankctl) ? 3 : 0;
# line 458 "../pf4.st"
				seq_pvPutTmo(seqg_env, 20/*bankctl*/, SYNC, DEFAULT_TIMEOUT);
# line 460 "../pf4.st"
				if (seqg_var->debug_flag >= 2)
				{
# line 460 "../pf4.st"
					printf("<%s,%d,%s,%d> ", "../pf4.st", 460, seqg_var->SNLtaskName, 2);
# line 460 "../pf4.st"
					;
# line 460 "../pf4.st"
					printf("%s\n", "energy timeout expired, force recalculation");
# line 460 "../pf4.st"
					epicsThreadSleep(0.01);
				}
# line 460 "../pf4.st"
				;
			}
		}
		return;
	case 11:
		{
# line 466 "../pf4.st"
			if (fillShowArrays(seqg_var->otherShow, seqg_var->numShow, seqg_var->showEnergy, seqg_var->showTransmission) == 0)
			{
# line 467 "../pf4.st"
				seq_pvPutTmo(seqg_env, 51/*showEnergy*/, DEFAULT, DEFAULT_TIMEOUT);
# line 468 "../pf4.st"
				seq_pvPutTmo(seqg_env, 52/*showTransmission*/, DEFAULT, DEFAULT_TIMEOUT);
			}
		}
		return;
	}
}

#undef seqg_var

/************************ Tables ************************/

/* Channel table */
static seqChan seqg_chans[] = {
	/* chName, offset, varName, varType, count, eventNum, efId, monitored, queueSize, queueIndex */
	{"{BP}{B1}", offsetof(struct seqg_vars, b1), "b1", P_INT, 1, 24, 1, 1, 0, 0},
	{"{BP}{B2}", offsetof(struct seqg_vars, b2), "b2", P_INT, 1, 25, 2, 1, 0, 0},
	{"{BP}{B3}", offsetof(struct seqg_vars, b3), "b3", P_INT, 1, 26, 3, 1, 0, 0},
	{"{BP}{B4}", offsetof(struct seqg_vars, b4), "b4", P_INT, 1, 27, 4, 1, 0, 0},
	{"{M}", offsetof(struct seqg_vars, monoenergy), "monoenergy", P_DOUBLE, 1, 28, 5, 1, 0, 0},
	{"{P}{H}displayBit1{B}", offsetof(struct seqg_vars, displayBit1), "displayBit1", P_INT, 1, 29, 0, 0, 0, 0},
	{"{P}{H}displayBit2{B}", offsetof(struct seqg_vars, displayBit2), "displayBit2", P_INT, 1, 30, 0, 0, 0, 0},
	{"{P}{H}displayBit3{B}", offsetof(struct seqg_vars, displayBit3), "displayBit3", P_INT, 1, 31, 0, 0, 0, 0},
	{"{P}{H}displayBit4{B}", offsetof(struct seqg_vars, displayBit4), "displayBit4", P_INT, 1, 32, 0, 0, 0, 0},
	{"{P}{H}displayEnergy", offsetof(struct seqg_vars, displayEnergy), "displayEnergy", P_DOUBLE, 1, 33, 0, 0, 0, 0},
	{"{P}{H}useMono", offsetof(struct seqg_vars, selectenergy), "selectenergy", P_INT, 1, 34, 6, 1, 0, 0},
	{"{P}{H}E:local", offsetof(struct seqg_vars, localenergy), "localenergy", P_DOUBLE, 1, 35, 7, 1, 0, 0},
	{"{P}{H}filterAl", offsetof(struct seqg_vars, filterAl), "filterAl", P_DOUBLE, 1, 36, 0, 0, 0, 0},
	{"{P}{H}filterTi", offsetof(struct seqg_vars, filterTi), "filterTi", P_DOUBLE, 1, 37, 0, 0, 0, 0},
	{"{P}{H}filterGlass", offsetof(struct seqg_vars, filterGl), "filterGl", P_DOUBLE, 1, 38, 0, 0, 0, 0},
	{"{P}{H}trans{B}", offsetof(struct seqg_vars, trans), "trans", P_DOUBLE, 1, 39, 0, 0, 0, 0},
	{"{P}{H}invTrans{B}", offsetof(struct seqg_vars, invtrans), "invtrans", P_DOUBLE, 1, 40, 0, 0, 0, 0},
	{"{P}{H}debug{B}", offsetof(struct seqg_vars, debug_flag), "debug_flag", P_INT, 1, 41, 8, 1, 0, 0},
	{"{P}{H}bitFlag{B}", offsetof(struct seqg_vars, bitflg), "bitflg", P_INT, 1, 42, 0, 0, 0, 0},
	{"{P}{H}status{B}", offsetof(struct seqg_vars, bitsts), "bitsts", P_SHORT, 1, 43, 0, 0, 0, 0},
	{"{P}{H}bank{B}", offsetof(struct seqg_vars, bankctl), "bankctl", P_SHORT, 1, 44, 9, 1, 0, 0},
	{"{P}{H}fPos{B}", offsetof(struct seqg_vars, filpos), "filpos", P_SHORT, 1, 45, 10, 1, 0, 0},
	{"{P}{H}fPos{B}.ZRST", offsetof(struct seqg_vars, a00), "a00", P_STRING, 1, 46, 0, 0, 0, 0},
	{"{P}{H}fPos{B}.ONST", offsetof(struct seqg_vars, a01), "a01", P_STRING, 1, 47, 0, 0, 0, 0},
	{"{P}{H}fPos{B}.TWST", offsetof(struct seqg_vars, a02), "a02", P_STRING, 1, 48, 0, 0, 0, 0},
	{"{P}{H}fPos{B}.THST", offsetof(struct seqg_vars, a03), "a03", P_STRING, 1, 49, 0, 0, 0, 0},
	{"{P}{H}fPos{B}.FRST", offsetof(struct seqg_vars, a04), "a04", P_STRING, 1, 50, 0, 0, 0, 0},
	{"{P}{H}fPos{B}.FVST", offsetof(struct seqg_vars, a05), "a05", P_STRING, 1, 51, 0, 0, 0, 0},
	{"{P}{H}fPos{B}.SXST", offsetof(struct seqg_vars, a06), "a06", P_STRING, 1, 52, 0, 0, 0, 0},
	{"{P}{H}fPos{B}.SVST", offsetof(struct seqg_vars, a07), "a07", P_STRING, 1, 53, 0, 0, 0, 0},
	{"{P}{H}fPos{B}.EIST", offsetof(struct seqg_vars, a08), "a08", P_STRING, 1, 54, 0, 0, 0, 0},
	{"{P}{H}fPos{B}.NIST", offsetof(struct seqg_vars, a09), "a09", P_STRING, 1, 55, 0, 0, 0, 0},
	{"{P}{H}fPos{B}.TEST", offsetof(struct seqg_vars, a10), "a10", P_STRING, 1, 56, 0, 0, 0, 0},
	{"{P}{H}fPos{B}.ELST", offsetof(struct seqg_vars, a11), "a11", P_STRING, 1, 57, 0, 0, 0, 0},
	{"{P}{H}fPos{B}.TVST", offsetof(struct seqg_vars, a12), "a12", P_STRING, 1, 58, 0, 0, 0, 0},
	{"{P}{H}fPos{B}.TTST", offsetof(struct seqg_vars, a13), "a13", P_STRING, 1, 59, 0, 0, 0, 0},
	{"{P}{H}fPos{B}.FTST", offsetof(struct seqg_vars, a14), "a14", P_STRING, 1, 60, 0, 0, 0, 0},
	{"{P}{H}fPos{B}.FFST", offsetof(struct seqg_vars, a15), "a15", P_STRING, 1, 61, 0, 0, 0, 0},
	{"{P}{H}f1{B}", offsetof(struct seqg_vars, f1), "f1", P_DOUBLE, 1, 62, 11, 1, 0, 0},
	{"{P}{H}f2{B}", offsetof(struct seqg_vars, f2), "f2", P_DOUBLE, 1, 63, 12, 1, 0, 0},
	{"{P}{H}f3{B}", offsetof(struct seqg_vars, f3), "f3", P_DOUBLE, 1, 64, 13, 1, 0, 0},
	{"{P}{H}f4{B}", offsetof(struct seqg_vars, f4), "f4", P_DOUBLE, 1, 65, 14, 1, 0, 0},
	{"{P}{H}Z1{B}", offsetof(struct seqg_vars, z1), "z1", P_SHORT, 1, 66, 15, 1, 0, 0},
	{"{P}{H}Z2{B}", offsetof(struct seqg_vars, z2), "z2", P_SHORT, 1, 67, 16, 1, 0, 0},
	{"{P}{H}Z3{B}", offsetof(struct seqg_vars, z3), "z3", P_SHORT, 1, 68, 17, 1, 0, 0},
	{"{P}{H}Z4{B}", offsetof(struct seqg_vars, z4), "z4", P_SHORT, 1, 69, 18, 1, 0, 0},
	{"{P}{H}Other1{B}", offsetof(struct seqg_vars, other1), "other1", P_STRING, 1, 70, 19, 1, 0, 0},
	{"{P}{H}Other2{B}", offsetof(struct seqg_vars, other2), "other2", P_STRING, 1, 71, 20, 1, 0, 0},
	{"{P}{H}Other3{B}", offsetof(struct seqg_vars, other3), "other3", P_STRING, 1, 72, 21, 1, 0, 0},
	{"{P}{H}Other4{B}", offsetof(struct seqg_vars, other4), "other4", P_STRING, 1, 73, 22, 1, 0, 0},
	{"{P}{H}OtherShow", offsetof(struct seqg_vars, otherShow), "otherShow", P_STRING, 1, 74, 23, 1, 0, 0},
	{"{P}{H}E", offsetof(struct seqg_vars, showEnergy), "showEnergy", P_FLOAT, 300, 75, 0, 0, 0, 0},
	{"{P}{H}T", offsetof(struct seqg_vars, showTransmission), "showTransmission", P_FLOAT, 300, 76, 0, 0, 0, 0},
	{"{P}{H}E.NELM", offsetof(struct seqg_vars, numShow), "numShow", P_INT, 1, 77, 0, 1, 0, 0},
	{"{P}{H}OtherLegal1{B}", offsetof(struct seqg_vars, otherLegal1), "otherLegal1", P_SHORT, 1, 78, 0, 0, 0, 0},
	{"{P}{H}OtherLegal2{B}", offsetof(struct seqg_vars, otherLegal2), "otherLegal2", P_SHORT, 1, 79, 0, 0, 0, 0},
	{"{P}{H}OtherLegal3{B}", offsetof(struct seqg_vars, otherLegal3), "otherLegal3", P_SHORT, 1, 80, 0, 0, 0, 0},
	{"{P}{H}OtherLegal4{B}", offsetof(struct seqg_vars, otherLegal4), "otherLegal4", P_SHORT, 1, 81, 0, 0, 0, 0},
};

/* Event masks for state set "pf4" */
static const seqMask seqg_mask_pf4_0_init[] = {
	0x00000000,
	0x00000000,
	0x00000000,
};
static const seqMask seqg_mask_pf4_0_filterBits[] = {
	0x00000000,
	0x00000000,
	0x00000000,
};
static const seqMask seqg_mask_pf4_0_filterPos[] = {
	0x00000000,
	0x00000000,
	0x00000000,
};
static const seqMask seqg_mask_pf4_0_recalcBank[] = {
	0x00000000,
	0x00000000,
	0x00000000,
};
static const seqMask seqg_mask_pf4_0_bankControl[] = {
	0x00000000,
	0x00001000,
	0x00000000,
};
static const seqMask seqg_mask_pf4_0_bankOff[] = {
	0x00000000,
	0x00001000,
	0x00000000,
};
static const seqMask seqg_mask_pf4_0_idle[] = {
	0x00fffffe,
	0x00001000,
	0x00000000,
};

/* State table for state set "pf4" */
static seqState seqg_states_pf4[] = {
	{
	/* state name */        "init",
	/* action function */   seqg_action_pf4_0_init,
	/* event function */    seqg_event_pf4_0_init,
	/* entry function */    0,
	/* exit function */     0,
	/* event mask array */  seqg_mask_pf4_0_init,
	/* state options */     (0)
	},
	{
	/* state name */        "filterBits",
	/* action function */   seqg_action_pf4_0_filterBits,
	/* event function */    seqg_event_pf4_0_filterBits,
	/* entry function */    0,
	/* exit function */     0,
	/* event mask array */  seqg_mask_pf4_0_filterBits,
	/* state options */     (0)
	},
	{
	/* state name */        "filterPos",
	/* action function */   seqg_action_pf4_0_filterPos,
	/* event function */    seqg_event_pf4_0_filterPos,
	/* entry function */    0,
	/* exit function */     0,
	/* event mask array */  seqg_mask_pf4_0_filterPos,
	/* state options */     (0)
	},
	{
	/* state name */        "recalcBank",
	/* action function */   seqg_action_pf4_0_recalcBank,
	/* event function */    seqg_event_pf4_0_recalcBank,
	/* entry function */    0,
	/* exit function */     0,
	/* event mask array */  seqg_mask_pf4_0_recalcBank,
	/* state options */     (0)
	},
	{
	/* state name */        "bankControl",
	/* action function */   seqg_action_pf4_0_bankControl,
	/* event function */    seqg_event_pf4_0_bankControl,
	/* entry function */    0,
	/* exit function */     0,
	/* event mask array */  seqg_mask_pf4_0_bankControl,
	/* state options */     (0)
	},
	{
	/* state name */        "bankOff",
	/* action function */   seqg_action_pf4_0_bankOff,
	/* event function */    seqg_event_pf4_0_bankOff,
	/* entry function */    0,
	/* exit function */     0,
	/* event mask array */  seqg_mask_pf4_0_bankOff,
	/* state options */     (0)
	},
	{
	/* state name */        "idle",
	/* action function */   seqg_action_pf4_0_idle,
	/* event function */    seqg_event_pf4_0_idle,
	/* entry function */    0,
	/* exit function */     0,
	/* event mask array */  seqg_mask_pf4_0_idle,
	/* state options */     (0)
	},
};

/* State set table */
static seqSS seqg_statesets[] = {
	{
	/* state set name */    "pf4",
	/* states */            seqg_states_pf4,
	/* number of states */  7
	},
};

/* Program table (global) */
seqProgram pf4 = {
	/* magic number */      2002005,
	/* program name */      "pf4",
	/* channels */          seqg_chans,
	/* num. channels */     58,
	/* state sets */        seqg_statesets,
	/* num. state sets */   1,
	/* user var size */     sizeof(struct seqg_vars),
	/* param */             "name=pf4,P=,H=,B=,BP=,B1=,B2=,B3=,B4=,M=",
	/* num. event flags */  23,
	/* encoded options */   (0 | OPT_DEBUG | OPT_NEWEF | OPT_REENT),
	/* init func */         seqg_init,
	/* entry func */        0,
	/* exit func */         0,
	/* num. queues */       0
};
# line 480 "../pf4.st"




double AlAbsorptionLength(double keV)
{
    double Wcoef0[]={1.90195,-0.00120447,4.3745e-7,8.68635e-11,3.40793e-15,-1.05816e-19,5.83389e-25};
    double Wcoef1[]={-1625.33,0.328256,-2.68391e-5,1.26554e-9,-2.41557e-14,2.12864e-19,-7.28743e-25};
    double kink = 26797.5;
    double* pointer;
    double sum,power;
    double eV;
    int i;

    eV = keV * 1000;
    if (eV>60000.) eV = 60000.;
    pointer = (eV<kink) ? Wcoef0 : Wcoef1;
    sum = 0.;
    power=1.;
    for( i=0; i<7; i++ )
    {
        sum += pointer[i] * power;
        power *= eV;
    }
    return sum;
}



double TiAbsorptionLength(double keV)
{
    double eV;
    double mu;

    eV = keV * 1000.;
    if( eV < 1e3 ) mu = 0;
    else if( eV < 4966.4 )
    {
        double c0=0.00092284;
        double c1=2.5891e+08;
        double powA=-2.6651;
        mu = c0+c1*pow(eV,powA);
    }
    else
    {

        double offset = 5.63768167444831e-5;
        double amp = 24061652313.4169;
        double powB = -2.91380053083527;
        double intercept = -0.268162843203489;
        double slope = 3.74221014277593e-5;

        double ampExp = -1.05663835782997;
        double invTau = -0.000570785180739491;
        double extra = (eV < 6456) ? (intercept+slope*eV) : (ampExp*exp(invTau*eV));
        mu = (offset + amp*pow(eV,powB) + extra);
    }
    return( 1./mu );
}
# 553 "../pf4.st"
double GlassAbsorptionLength(double keV)
{
    double absLength;
    double c0,c1,c2;
    double c3,c4,c5,c6,c7;
    double keV2, keVn;
    keV2 = keV*keV;

    if( keV < 2 )
        absLength = 0;
    else if( keV < 2.472 )
    {
        c0 = 0.5059463974;
        c1 = -0.1259565387;
        c2 = 0.01763933889;
        absLength = c0 + c1*keV + c2*keV2;
    }
    else if( keV < 3.6084 )
    {
        c0 = 0.4570603245;
        c1 = -0.08869920063;
        c2 = 0.01032934773;
        absLength = c0 + c1*keV + c2*keV2;
    }
    else if( keV < 4.0385 )
    {
        c0 = 0.3708574258;
        c1 = -0.04453063888;
        c2 = 3.979930821e-3;
        absLength = c0 + c1*keV + c2*keV2;
    }
    else if( keV < 7.112 )
    {
        c0 = 0.2830642538;
        c1 = -0.0223186563;
        c2 = 1.412011413e-3;
        absLength = c0 + c1*keV + c2*keV2;
    }
    else
    {
        c0 = 0.2715022686;
        c1 = -0.02428526798;
        c2 = 2.984228845e-3;
        c3 = -2.003675391e-4;
        c4 = 7.983398893e-6;
        c5 = -1.869726202e-7;
        c6 = 2.378962632e-9;
        c7 = -1.270082060e-11;
        absLength = c0 + c1*keV;
        keVn = keV2; absLength += c2*keVn;
        keVn *= keV; absLength += c3*keVn;
        keVn *= keV; absLength += c4*keVn;
        keVn *= keV; absLength += c5*keVn;
        keVn *= keV; absLength += c6*keVn;
        keVn *= keV; absLength += c7*keVn;
    }
    absLength *= keV*keV*keV;
    return( absLength );
}

int isLegalOther(char *s) {
 int i;
 for (i=0; i<NUM_SPECIES; i++) {
  if (strcmp(filtermat[i].name, s) == 0) break;
 }
 if (i >= NUM_SPECIES) return(0);
 return(1);
}

double OtherAbsorptionLength(double keV, char *species) {
 int i, j;
 double mu, frac, absLen;

 for (i=0; i<NUM_SPECIES; i++) {
  if (strcmp(filtermat[i].name, species) == 0) break;
 }
 if (i >= NUM_SPECIES) {

  return(0.);
 }

 for (j=0; j<filtermat[i].numEntries; j++) {
  if (keV < filtermat[i].keV[j]) break;
 }
 if (j >= filtermat[i].numEntries) {

  return(0.);
 }

 frac = (keV - filtermat[i].keV[j]) / (filtermat[i].keV[j+1] - filtermat[i].keV[j]);
 mu = filtermat[i].mu[j] + frac * (filtermat[i].mu[j+1] - filtermat[i].mu[j]);
 absLen = 1/(matdensity[i]*mu);
 absLen *= 1.e4;
 return(absLen);
}


void RecalcFilters(double keV,short* bits,double* xmit,int d,int b,int z1,
                    int z2,int z3,int z4,double f1,double f2,double f3,double f4,
     char *other1, char *other2, char *other3, char *other4)
{
    double absLenAl,absLenTi,absLenGlass;
    double xAl,xTi,xGlass;
 double xOther1, xOther2, xOther3, xOther4;
    int i;
 double absLenOther1=0, absLenOther2=0, absLenOther3=0, absLenOther4=0;

    if (d >= 10) printf("\nRecalcFilters: keV=%g\n",keV);
    absLenAl = AlAbsorptionLength(keV);
    absLenTi = TiAbsorptionLength(keV);
    absLenGlass = GlassAbsorptionLength(keV);
 if (z1==3) absLenOther1 = OtherAbsorptionLength(keV, other1);
 if (z2==3) absLenOther2 = OtherAbsorptionLength(keV, other2);
 if (z3==3) absLenOther3 = OtherAbsorptionLength(keV, other3);
 if (z4==3) absLenOther4 = OtherAbsorptionLength(keV, other4);

    for (i=0;i<16;i++)
    {
        if (b)
        {
            xAl = (z1==0 && i&1) ? f1 : 0;
            xAl += (z2==0 && i&2) ? f2 : 0;
            xAl += (z3==0 && i&4) ? f3 : 0;
            xAl += (z4==0 && i&8) ? f4 : 0;
            xTi = (z1==1 && i&1) ? f1 : 0;
            xTi += (z2==1 && i&2) ? f2 : 0;
            xTi += (z3==1 && i&4) ? f3 : 0;
            xTi += (z4==1 && i&8) ? f4 : 0;
            xGlass = (z1==2 && i&1) ? f1 : 0;
            xGlass += (z2==2 && i&2) ? f2 : 0;
            xGlass += (z3==2 && i&4) ? f3 : 0;
            xGlass += (z4==2 && i&8) ? f4 : 0;
   xOther1 = (z1==3 && i&1) ? f1 : 0;
   xOther2 = (z2==3 && i&2) ? f2 : 0;
   xOther3 = (z3==3 && i&4) ? f3 : 0;
   xOther4 = (z4==3 && i&8) ? f4 : 0;
           if (d >= 10)
            {
                printf("       in RecalcFilters %3d, Aluminum = %g,   Titanium = %g,   Glass = %g\n",i,xAl,xTi,xGlass);
            }
            xmit[i] = exp(-xAl*1000./absLenAl);
            xmit[i] *= exp(-xTi*1000./absLenTi);
            xmit[i] *= exp(-xGlass*1000./absLenGlass);
   if (xOther1 > 0) xmit[i] *= exp(-xOther1*1000./absLenOther1);
   if (xOther2 > 0) xmit[i] *= exp(-xOther2*1000./absLenOther2);
   if (xOther3 > 0) xmit[i] *= exp(-xOther3*1000./absLenOther3);
   if (xOther4 > 0) xmit[i] *= exp(-xOther4*1000./absLenOther4);
        }
        else
            xmit[i] = 1.;
        bits[i] = i;
    }
    if (b) sortDecreasing(d,xmit,bits,16);
}


void sortDecreasing(int d,double* arr,short* bits,int n)
{
    int ii, jj;
    double a;
    short b;

    if (d >= 9)
    {
        printf("       before sorting, bits=%d",bits[0]);
        for (ii=1; ii<n; ii++)
        {
            printf(",%d", bits[ii]);
        }
        printf("\n");
        if (d >= 10)
        {
            printf("                   transmit=%g",arr[0]);
            for (ii=1; ii<n/3; ii++)
            {
                printf(", %g", arr[ii]);
            }
            printf("\n");
        }
    }

    for (jj=1;jj<n;jj++)
    {
        a = arr[jj];
        b = bits[jj];
        ii = jj-1;
        while(ii>=0 && arr[ii]<a)
        {
            arr[ii+1] = arr[ii];
            bits[ii+1] = bits[ii];
            ii--;
        }
        arr[ii+1] = a;
        bits[ii+1] = b;
    }

    if (d >= 8)
    {
        printf("       after sorting, bits=%d",bits[0]);
        for (ii=1; ii<n; ii++)
        {
            printf(",%d", bits[ii]);
        }
        printf("\n");
        if (d >= 10)
        {
            printf("                   transmit=%g",arr[0]);
            for (ii=1; ii<n/3; ii++)
            {
                printf(", %g", arr[ii]);
            }
            printf("\n");
        }
    }
}



double thickZ(int z,int b,int b1,int b2,int b3,int b4,int z1,int z2,int z3,
              int z4,double f1,double f2,double f3,double f4)
{
    double sum = 0.0;

    if( b )
    {
        sum += (b1 && (z1==z)) ? f1 : 0;
        sum += (b2 && (z2==z)) ? f2 : 0;
        sum += (b3 && (z3==z)) ? f3 : 0;
        sum += (b4 && (z4==z)) ? f4 : 0;
    }

    return sum;
}




int numInArray(int N,short arr[],short value)
{
    int i;

    for( i=0; i<N; i++ ) if( value==arr[i] ) return i;
    return 0;
}

static int fillShowArrays(char *species, int N, float *E, float *T) {
 int i, j, k;

 for (i=0; i<NUM_SPECIES; i++) {
  if (strcmp(filtermat[i].name, species) == 0) break;
 }
 if (i >= NUM_SPECIES) {
  return(1);
 }

 for (j=0; j<filtermat[i].numEntries; j++) {
  E[j] = filtermat[i].keV[j];
  T[j] = filtermat[i].mu[j];
 }
 k = j-1;
 for (; j<N; j++) {
  E[j] = filtermat[i].keV[k];
  T[j] = filtermat[i].mu[k];
 }
 return(0);
}



/* Register sequencer commands and program */
#include "epicsExport.h"
static void pf4Registrar (void) {
    seqRegisterSequencerCommands();
    seqRegisterSequencerProgram (&pf4);
}
epicsExportRegistrar(pf4Registrar);
